<h1>Associate Suppliers with Products</h1>

<% if @csv_data.blank? %>
  <!-- File Upload Form -->
  <%= form_with url: import_products_path, method: :post, multipart: true, class: "mb-4" do |f| %>
    <div class="mb-3">
      <%= f.file_field :file, class: "form-control" %>
    </div>
    <div>
      <%= f.submit "Upload CSV", class: "btn btn-primary" %>
    </div>
  <% end %>
<% else %>
  <!-- Bulk Update Form -->
  <%= form_with url: bulk_update_products_path, method: :post do |f| %>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>SKU</th>
          <th>Product Title</th>
          <% if @csv_data.first["suppliers"].present? %>
            <% @csv_data.first["suppliers"].each_with_index do |supplier, index| %>
              <th>Supplier <%= index + 1 %> Name</th>
              <th>Supplier <%= index + 1 %> Cost</th>
              <th>Supplier <%= index + 1 %> Ref</th>
            <% end %>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @csv_data.each do |row| %>
          <tr>
            <td><%= row["sku_code"] %></td>
            <td><%= row["product_title"] %></td>
            <% row["suppliers"].each do |supplier| %>
              <td><%= supplier["supplier_name"] %></td>
              <td>
                <%= text_field_tag "supplier_cost[#{row['sku_code']}][#{supplier['supplier_id']}]", supplier["supplier_cost"], class: "form-control" %>
              </td>
              <td><%= supplier["supplier_ref"] %></td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
    <div class="mt-3">
      <%= f.submit "Save Changes", class: "btn btn-success" %>
    </div>
  <% end %>
  <div class="mt-3">
    <%= link_to "Export CSV", export_products_path, class: "btn btn-secondary" %>
    <%= link_to "Upload New CSV", clear_products_path, class: "btn btn-danger" %>
  </div>
<% end %>
